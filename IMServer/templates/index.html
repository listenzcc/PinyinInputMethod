<!DOCTYPE html>
<html>

<head>
    <meta chars="utf-8" />
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style type="text/css">
        div {
            margin: 3px;
            padding: 2px;
            border: 1px solid forestgreen;
        }
        
        div:hover {
            border-color: goldenrod;
        }
        
        div#Area-3 {
            width: 6in;
            height: 4in;
            overflow-y: scroll;
        }
        
        div#Area-4 {
            width: 6in;
            height: 4in;
            overflow-y: scroll;
        }
        
        input#Input-2 {
            width: 6in;
            height: 1in;
            overflow-y: scroll;
        }
        
        div.flex-display {
            display: flex;
        }
        
        div.row-candidates {
            background-color: antiquewhite;
        }
        
        p.col-candidate {
            margin-left: 10px;
        }
        
        p.col-candidate:hover {
            background-color: yellow;
            transform: rotate(7deg) scale(1.2);
        }
        
        p.row-sentence:hover {
            background-color: yellow;
        }
        
        input {
            margin-right: 5px;
        }
    </style>
</head>

<body>
    <!-- Slogan -->
    <div id="Area-1">
        <h1>IM System Demo</h1>
        <p>Start at {{currentTime}}</p>
    </div>

    <!-- Input Area -->
    <div id="Area-2">
        <h2>Input Area</h2>
        <div class='flex-display'>
            <input id='Input-1' type="text" oninput="query()" />
            <input type='button' value='C' onclick="inputByClick('C')" />
            <input type='button' value=',' onclick="inputByClick(',')" />
            <input type='button' value='.' onclick="inputByClick('.')" />
            <input type='button' value='B' onclick="inputByClick('B')" />
            <input type='button' value='K' onclick="inputByClick('K')" />
        </div>
        <div>
            <input id='Input-2' type="text" />
        </div>
    </div>

    <!-- Display Area -->
    <div class='flex-display'>
        <div>
            <h2>Candidates</h2>
            <div id="Area-3">
            </div>
        </div>
        <div>
            <h2>Contexts</h2>
            <div id="Area-4">
            </div>
        </div>
    </div>

    <script type="text/javascript">
        function inputByClick(c) {
            if (c == 'C') {
                document.getElementById('Input-1').value = ''
            }
            if (c == 'K') {
                document.getElementById('Input-1').value = ''
                document.getElementById('Input-2').value = ''
            }

            if (c == 'B') {
                let value = document.getElementById('Input-2').value
                let len = value.length
                document.getElementById('Input-2').value = value.substring(0, len - 1)
            }

            if (c == ',' || c == '.') {
                document.getElementById('Input-2').value += c
            }

            document.getElementById("Input-1").focus()
            document.getElementById("Input-1").select()
        }

        function clear(dom) {
            // Remove all children from the [dom]
            while (dom.childElementCount > 0) {
                dom.children[0].remove();
            }
        }

        function json2lst(json) {
            // Convert json into lst
            let max = 100;
            let lst = [];
            for (let i in json.candidates) {
                lst[lst.length] = [json.candidates[i], json.pinYin[i]];
                if (i > max) {
                    break;
                }
            }
            return lst;
        }

        function query() {
            let value = document.getElementById("Input-1").value;
            console.log(value);

            while (value.startsWith(" ")) {
                value = value.substring(1);
            }

            while (value.endsWith(" ")) {
                value = value.substring(0, value.length - 1);
            }

            if (value.length == 0) {
                console.log('Empty value received, doing nothing.')
                return 1;
            }

            clear(document.getElementById("Area-3"));

            let inp2 = document.getElementById("Input-2");

            d3.json("query/" + value).then(function(json) {
                console.log(json);
                let lst = json2lst(json);
                d3.select("#Area-3")
                    .selectAll("div")
                    .data(lst)
                    .enter()
                    .append("div")
                    .attr('class', 'row-candidates flex-display')
                    .selectAll('p')
                    .data(d => (d[0]))
                    .enter()
                    .append('p')
                    .attr('class', 'col-candidate')
                    .html(d => (d))
                    .on('click', function(e, d) {
                        // Onclick response of candidate ciZu in Chinese
                        // Record the clicked ciZu into inp2.value
                        inp2.value += d
                        inputByClick('')

                        // Update the Area-4 for the contents containing the ciZu
                        d3.json('guess/' + d).then(function(json) {
                            clear(document.getElementById('Area-4'));
                            let max = 100;
                            let lst = [];
                            for (let i in json.sentence) {
                                lst[lst.length] = json.sentence[i];
                                if (i > max) {
                                    break;
                                }
                            }
                            d3.select('#Area-4')
                                .selectAll('p')
                                .data(lst)
                                .enter()
                                .append('p')
                                .attr('class', 'row-sentence')
                                .html(d => (d))
                        })
                    });
            });
        }
    </script>
</body>

</html>